---
# ==============================================================================
# GitLab CI/CD Pipeline for Helm Charts Repository
# ==============================================================================
#
# Purpose:
#   Automated validation, packaging, and publishing of Helm charts to OCI
#   registry with comprehensive testing and metrics collection.
#
# Pipeline Stages:
#   1. build    - Build Golden CI Image with all required tools
#   2. test     - Test Python CI scripts with pytest and coverage
#   3. lint     - YAML/Shell/Markdown linting with Code Quality integration
#   4. detect   - Detect which charts have changed for targeted processing
#   5. validate - Validate Helm charts with helm lint and template rendering
#   6. package  - Package validated charts into .tgz files
#   7. security - Secret scanning with Gitleaks (SARIF reports)
#   8. publish  - Push charts to OCI registry and GitHub portfolio
#   9. notify   - Send validation and publish notifications
#   10. metrics  - Collect chart performance metrics (scheduled)
#   11. renovate - Automated dependency updates (scheduled)
#
# Key Features:
#   - 100% Python-based CI scripts (no bash dependencies)
#   - Automated testing of CI scripts with pytest and coverage tracking
#   - Golden CI Image strategy for consistent, fast builds
#   - Modular linting with smart change detection (YAML, Shell, Markdown)
#   - GitLab Code Quality integration for YAML linting
#   - Secret scanning with Gitleaks (SARIF reports for Security Dashboard)
#   - Comprehensive Helm chart validation and testing
#   - Idempotent chart publishing with version checks
#   - Automated notifications for validation and publish events
#   - Performance metrics tracking
#   - Single Source of Truth for all tool versions
#
# Maintainer: maintainer@example.io
# Repository: https://gitlab.example.com/homelab/helm-charts
# ==============================================================================

# ==============================================================================
# Pipeline Stages
# ==============================================================================

stages:
  - build
  - test
  - lint
  - detect
  - validate
  - package
  - security
  - publish
  - notify
  - metrics
  - renovate

# ==============================================================================
# Global Variables
# ==============================================================================

variables:
  # Docker Images
  # renovate: datasource=docker depName=docker versioning=docker
  DOCKER_BASE_VERSION: "29.2.1"
  DOCKER_VERSION: "29.1.4-cli"
  CI_IMAGE: "${CI_REGISTRY_IMAGE}/ci:latest"

  # Tool versions (tracked by Renovate)

  # Helm Tools
  # renovate: datasource=docker depName=alpine/helm
  HELM_VERSION: "4.1.1"

  # Linting Tools
  # renovate: datasource=pypi depName=yamllint
  YAMLLINT_VERSION: "1.38.0"
  # renovate: datasource=docker depName=koalaman/shellcheck-alpine
  SHELLCHECK_VERSION: "v0.11.0"
  # renovate: datasource=npm depName=markdownlint-cli2
  MARKDOWNLINT_VERSION: "0.21.0"

  # Python Dependencies
  # renovate: datasource=pypi depName=pyyaml
  PYYAML_VERSION: "6.0.3"
  # renovate: datasource=pypi depName=tqdm
  TQDM_VERSION: "4.67.3"
  # renovate: datasource=pypi depName=pytest
  PYTEST_VERSION: "9.0.2"
  # renovate: datasource=pypi depName=pytest-cov
  PYTEST_COV_VERSION: "7.0.0"
  # renovate: datasource=pypi depName=requests
  REQUESTS_VERSION: "2.32.5"

  # Security Tools
  # renovate: datasource=github-releases depName=gitleaks/gitleaks
  GITLEAKS_VERSION: "v8.30.0"

  # CI/CD Tools
  # renovate: datasource=docker depName=renovate/renovate
  RENOVATE_VERSION: "43.30"

  # Repository Settings
  CHARTS_DIR: "charts"
  PACKAGES_DIR: ".packages"

  # Git Configuration
  # Full history required for accurate change detection
  GIT_DEPTH: 0

# ==============================================================================
# Job Templates
# ==============================================================================
# Reusable job configurations to reduce duplication

# Base template for all jobs using the Golden CI Image
.base-job:
  image: $CI_IMAGE
  tags:
    - talos

# Template for jobs that publish charts to OCI registry
.publish-job:
  extends: .base-job
  before_script:
    # Authenticate with GitLab container registry for publishing Helm charts
    - |
      echo "Logging in to container registry..."
      echo "$CI_REGISTRY_PASSWORD" | helm registry login "${CI_REGISTRY}" \
        -u "${CI_REGISTRY_USER}" \
        --password-stdin

# ==============================================================================
# Build Stage - Golden CI Image
# ==============================================================================
# Builds a Docker image containing all CI tools (Helm, yamllint, markdownlint,
# pytest, etc.) to ensure consistent, fast pipeline execution

# Template for building Docker images
.build-image-gitlab:
  image: docker:${DOCKER_VERSION}
  stage: build
  services:
    - name: docker:${DOCKER_BASE_VERSION}-dind
      command: ["--mtu=1300"]
  variables:
    # Docker-in-Docker configuration for Kubernetes executor
    # Use Unix socket (DinD shares /var/run via emptyDir volume)
    DOCKER_HOST: unix:///var/run/docker.sock
    # Disable TLS
    DOCKER_TLS_CERTDIR: ""
  tags:
    - talos
  before_script:
    # Wait for Docker socket to be created and fix permissions
    - |
      echo "Waiting for Docker socket to be created..."
      timeout=30
      until [ -S /var/run/docker.sock ] || [ $timeout -eq 0 ]; do
        echo "Waiting for docker.sock... ($timeout seconds remaining)"
        sleep 1
        timeout=$((timeout - 1))
      done
      if [ $timeout -eq 0 ]; then
        echo "ERROR: docker.sock was not created within 30 seconds"
        ls -la /var/run/ 2>&1
        exit 1
      fi
      echo "Socket found! Fixing permissions..."
      chmod 666 /var/run/docker.sock
    # Wait for Docker daemon to be ready
    - |
      echo "Waiting for Docker daemon to be ready..."
      timeout=30
      until docker info >/dev/null 2>&1 || [ $timeout -eq 0 ]; do
        echo "Waiting for docker daemon... ($timeout seconds remaining)"
        sleep 1
        timeout=$((timeout - 1))
      done
      if [ $timeout -eq 0 ]; then
        echo "ERROR: Docker daemon failed to respond within 30 seconds"
        docker info 2>&1 || true
        exit 1
      fi
      echo "Docker daemon is ready!"
      docker info
    # Authenticate with GitLab registry to push built images
    - |
      echo "$CI_JOB_TOKEN" | docker login -u "$CI_REGISTRY_USER" \
        --password-stdin "$CI_REGISTRY"
  script:
    - cd "$BUILD_CONTEXT"
    # Build multi-platform image with buildx, using registry cache for speed
    # MTU set to 1300 in DinD service to fix Alpine apk networking issues
    # See: https://github.com/gliderlabs/docker-alpine/issues/307
    - |
      docker buildx build \
        --progress=plain \
        --platform linux/amd64 \
        --cache-from type=registry,ref="$IMAGE_NAME:buildcache" \
        --cache-to type=registry,ref="$IMAGE_NAME:buildcache",mode=max \
        --build-arg DOCKER_VERSION=${DOCKER_VERSION} \
        --build-arg HELM_VERSION=${HELM_VERSION} \
        --build-arg YAMLLINT_VERSION=${YAMLLINT_VERSION} \
        --build-arg SHELLCHECK_VERSION=${SHELLCHECK_VERSION} \
        --build-arg MARKDOWNLINT_VERSION=${MARKDOWNLINT_VERSION} \
        --build-arg GITLEAKS_VERSION=${GITLEAKS_VERSION} \
        --build-arg PYYAML_VERSION=${PYYAML_VERSION} \
        --build-arg TQDM_VERSION=${TQDM_VERSION} \
        --build-arg PYTEST_VERSION=${PYTEST_VERSION} \
        --build-arg PYTEST_COV_VERSION=${PYTEST_COV_VERSION} \
        --build-arg REQUESTS_VERSION=${REQUESTS_VERSION} \
        -t "$IMAGE_NAME:latest" \
        --push \
        .

# Build the Golden CI Image containing all pipeline tools
build:ci-image:
  extends: .build-image-gitlab
  variables:
    IMAGE_NAME: $CI_REGISTRY_IMAGE/ci
    BUILD_CONTEXT: docker/ci
  rules:
    # Skip on scheduled pipelines (Renovate, metrics)
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # Rebuild when Renovate updates CI dependencies
    - if: >
        $CI_PIPELINE_SOURCE == "merge_request_event" &&
        $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME =~ /^renovate\//
      changes:
        - "docker/ci/**/*"
        - ".gitlab-ci.yml"
    # Rebuild on Renovate branches (fallback for branch pipelines)
    - if: '$CI_COMMIT_BRANCH =~ /^renovate\\//'
      changes:
        - "docker/ci/**/*"
        - ".gitlab-ci.yml"
    # Rebuild on main branch when CI configuration changes
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - "docker/ci/**/*"
        - ".gitlab-ci.yml"
    # Allow manual rebuilds via web UI
    - if: '$CI_PIPELINE_SOURCE == "web"'

# ==============================================================================
# Test Stage - CI Scripts
# ==============================================================================
# Test Python CI scripts with pytest and coverage reporting

test:ci-scripts:
  extends: .base-job
  stage: test
  needs:
    - job: build:ci-image
      optional: true
  script:
    - cd scripts/ci
    - pytest -v
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: scripts/ci/coverage.xml
    paths:
      - scripts/ci/htmlcov/
    expire_in: 7 days
    when: always
  rules:
    # Run on github_sync schedule (before publish job)
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $SCHEDULE_TYPE == "github_sync"'
      when: always
    # Run on metrics schedule (before metrics job)
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $SCHEDULE_TYPE == "metrics"'
      when: always
    # Exclude renovate schedule
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # Run on merge requests when CI scripts change
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - "scripts/ci/**/*.py"
        - "scripts/ci/requirements.txt"
        - "scripts/ci/pytest.ini"
    # Run on main branch when CI scripts change
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - "scripts/ci/**/*.py"
        - "scripts/ci/requirements.txt"
        - "scripts/ci/pytest.ini"

# ==============================================================================
# Lint Stage - Code Quality
# ==============================================================================
# YAML, Shell, and Markdown linting with GitLab Code Quality integration

# Lint YAML files with yamllint and generate Code Quality report
lint:yaml:
  extends: .base-job
  stage: lint
  needs:
    - job: build:ci-image
      optional: true
    - job: test:ci-scripts
      optional: true
  script:
    - >
      python3 scripts/ci/lint_yaml.py --format gitlab --verbose
      > gl-code-quality-report.json || true
  artifacts:
    reports:
      codequality: gl-code-quality-report.json
    when: always
    expire_in: 1 week
  rules:
    # Exclude scheduled pipelines (Renovate, metrics)
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # Lint YAML on tags
    - if: "$CI_COMMIT_TAG"
      changes:
        - "**/*.yaml"
        - "**/*.yml"
        - ".yamllint"
        - "scripts/ci/lint_yaml.py"
    # Lint YAML on main branch
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - "**/*.yaml"
        - "**/*.yml"
        - ".yamllint"
        - "scripts/ci/lint_yaml.py"
    # Lint YAML on merge requests
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - "**/*.yaml"
        - "**/*.yml"
        - ".yamllint"
        - "scripts/ci/lint_yaml.py"

# Lint shell scripts with ShellCheck for syntax and best practices
lint:shell:
  extends: .base-job
  stage: lint
  needs:
    - job: build:ci-image
      optional: true
    - job: test:ci-scripts
      optional: true
  script:
    - python3 scripts/ci/lint_shell.py --verbose
  artifacts:
    when: on_failure
    expire_in: 1 week
  rules:
    # Exclude scheduled pipelines (Renovate, metrics)
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # Lint shell scripts on tags
    - if: "$CI_COMMIT_TAG"
      changes:
        - "**/*.sh"
        - "scripts/ci/lint_shell.py"
    # Lint shell scripts on main branch
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - "**/*.sh"
        - "scripts/ci/lint_shell.py"
    # Lint shell scripts on merge requests
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - "**/*.sh"
        - "scripts/ci/lint_shell.py"

# Lint Markdown files with markdownlint for documentation quality
lint:markdown:
  extends: .base-job
  stage: lint
  needs:
    - job: build:ci-image
      optional: true
    - job: test:ci-scripts
      optional: true
  script:
    - python3 scripts/ci/lint_markdown.py --verbose
  artifacts:
    when: on_failure
    expire_in: 1 week
  rules:
    # Exclude scheduled pipelines (Renovate, metrics)
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # Lint markdown on tags
    - if: "$CI_COMMIT_TAG"
      changes:
        - "**/*.md"
        - "scripts/ci/lint_markdown.py"
    # Lint markdown on main branch
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - "**/*.md"
        - "scripts/ci/lint_markdown.py"
    # Lint markdown on merge requests
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - "**/*.md"
        - "scripts/ci/lint_markdown.py"

# ==============================================================================
# Detect Stage - Chart Change Detection
# ==============================================================================
# Detect which charts have changed for targeted validation and packaging

detect:changes:
  extends: .base-job
  stage: detect
  needs:
    - job: build:ci-image
      optional: true
    - job: test:ci-scripts
      optional: true
  script:
    - python3 scripts/ci/detect_changes.py --output changed-charts.txt
  artifacts:
    paths:
      - changed-charts.txt
    expire_in: 1 hour
  rules:
    # Exclude scheduled pipelines (Renovate, metrics)
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # Detect changes on tags
    - if: "$CI_COMMIT_TAG"
      changes:
        - "charts/**/*"
    # Detect changes on main branch
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - "charts/**/*"
    # Detect changes on merge requests
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - "charts/**/*"

# ==============================================================================
# Validate Stage - Chart Validation
# ==============================================================================
# Validate Helm charts using helm lint and template rendering

validate:charts:
  extends: .base-job
  stage: validate
  needs:
    - job: build:ci-image
      optional: true
    - job: test:ci-scripts
      optional: true
    - job: detect:changes
      artifacts: true
  script:
    - python3 scripts/ci/validate_chart.py --input-file changed-charts.txt
  rules:
    # Exclude scheduled pipelines (Renovate, metrics)
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # Validate charts on tags (release validation)
    - if: "$CI_COMMIT_TAG"
      changes:
        - "charts/**/*.yaml"
        - "charts/**/*.yml"
        - "charts/**/*.tpl"
    # Validate charts on main branch
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - "charts/**/*.yaml"
        - "charts/**/*.yml"
        - "charts/**/*.tpl"
    # Validate charts on merge requests
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - "charts/**/*.yaml"
        - "charts/**/*.yml"
        - "charts/**/*.tpl"

# ==============================================================================
# Package Stage - Helm Chart Packaging
# ==============================================================================
# Package validated charts into .tgz files for publishing

package:charts:
  extends: .base-job
  stage: package
  needs:
    - job: build:ci-image
      optional: true
    - job: test:ci-scripts
      optional: true
    - job: detect:changes
      artifacts: true
    - job: validate:charts
      optional: true
  script:
    - mkdir -p "$PACKAGES_DIR"
    - python3 scripts/ci/package_chart.py --input-file changed-charts.txt
  artifacts:
    paths:
      - ${PACKAGES_DIR}/*.tgz
    expire_in: 7 days
  rules:
    # Exclude scheduled pipelines (Renovate, metrics)
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # Package charts on tags (release packaging)
    - if: "$CI_COMMIT_TAG"
      changes:
        - "charts/**/*.yaml"
        - "charts/**/*.yml"
        - "charts/**/*.tpl"
    # Package charts on main branch
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - "charts/**/*.yaml"
        - "charts/**/*.yml"
        - "charts/**/*.tpl"
    # Package charts on merge requests
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - "charts/**/*.yaml"
        - "charts/**/*.yml"
        - "charts/**/*.tpl"

# ==============================================================================
# Security Stage - Secret Scanning
# ==============================================================================
# Scan for hardcoded secrets using Gitleaks with SARIF reports for
# GitLab Security Dashboard integration

security:scan-secrets:
  extends: .base-job
  stage: security
  needs:
    - job: build:ci-image
      optional: true
  script:
    # Use --no-git for scheduled github_sync (faster, no history needed for publish)
    # Use full history scan for MR/main (comprehensive security check)
    - |
      if [ "$SCHEDULE_TYPE" = "github_sync" ]; then
        echo "Running no-history scan for GitHub publish verification..."
        gitleaks detect \
          --source . \
          --config .gitleaks.toml \
          --no-git \
          --platform gitlab \
          --report-format sarif \
          --report-path gl-secret-detection-report.json \
          -v \
          --exit-code 1
      else
        echo "Running full history scan..."
        gitleaks detect \
          --source . \
          --config .gitleaks.toml \
          --platform gitlab \
          --report-format sarif \
          --report-path gl-secret-detection-report.json \
          -v \
          --exit-code 1
      fi
  artifacts:
    reports:
      # GitLab secret_detection report type for security dashboard integration
      secret_detection: gl-secret-detection-report.json
    paths:
      - gl-secret-detection-report.json
    expire_in: 7 week
    when: always
  rules:
    # Run on github_sync schedule (before publish)
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $SCHEDULE_TYPE == "github_sync"'
      when: always
    # Exclude other schedules (Renovate, metrics)
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # Scan secrets on merge requests
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    # Scan secrets on main branch
    - if: '$CI_COMMIT_BRANCH == "main"'

# ==============================================================================
# Publish Stage
# ==============================================================================

# Publish Helm charts to OCI registry
publish:charts:
  extends: .publish-job
  stage: publish
  needs:
    - job: build:ci-image
      optional: true
    - job: test:ci-scripts
      optional: true
    - job: detect:changes
      artifacts: true
    - job: package:charts
      artifacts: true
  script:
    - python3 scripts/ci/publish_chart.py --input-file changed-charts.txt
  rules:
    # Exclude scheduled pipelines (Renovate, metrics)
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # Publish charts on tags (automatic for releases)
    - if: "$CI_COMMIT_TAG"
      when: always
    # Publish charts on main branch (manual approval required)
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - "charts/*/Chart.yaml"
      when: on_success
      allow_failure: false
    # Never publish on merge requests
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never

# Publish sanitized repository to GitHub as portfolio
publish:github-portfolio:
  extends: .base-job
  stage: publish
  needs:
    - job: build:ci-image
      optional: true
    - job: test:ci-scripts
      optional: true
    - job: security:scan-secrets
  before_script:
    # Configure SSH for GitHub
    - mkdir -m 700 -p ~/.ssh
    # Copy SSH key from GitLab File variable (contains path to temp file)
    - cp "$GITHUB_SSH_PRIVATE_KEY" ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    # Verify key format
    - |
      if ! grep -q "BEGIN.*PRIVATE KEY" ~/.ssh/id_ed25519; then
        echo "ERROR: Invalid SSH key format"
        head -n 1 ~/.ssh/id_ed25519
        exit 1
      fi
    # Add GitHub host key
    - >
      ssh-keyscan -H github.com >> ~/.ssh/known_hosts 2>/dev/null
      || echo "Warning Could not fetch GitHub host keys"
    # Configure Git identity
    - git config --global user.name "maintainer-user"
    - git config --global user.email "maintainer-user@users.noreply.github.com"
  script:
    - python3 scripts/ci/publish_github.py --remote "$GITHUB_REPO_URL" --verbose
  rules:
    # Skip if commit message contains [skip publish]
    - if: '$CI_COMMIT_MESSAGE =~ /\[skip publish\]/'
      when: never
    # Run on schedule (daily at 4 AM)
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $SCHEDULE_TYPE == "github_sync"'
      when: always
    # Manual trigger option (via web UI)
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
      allow_failure: true
  allow_failure: false # Fail pipeline if verification fails or push errors
  tags:
    - talos
  timeout: 15 minutes
  artifacts:
    when: on_failure
    paths:
      - tools/sanitize/reports/
    expire_in: 7 days

# ==============================================================================
# Notify Stage
# ==============================================================================
# Send notifications when charts are validated or published

# Notify when validation and packaging completes (non-blocking)
notify:validated:
  extends: .base-job
  stage: notify
  needs:
    - job: detect:changes
      optional: true
    - job: package:charts
      optional: true
  script:
    - python3 scripts/ci/notify.py --type validated --input-file changed-charts.txt
  dependencies:
    - detect:changes
  rules:
    # Exclude scheduled pipelines (Renovate, metrics)
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # Send validation notification on tags
    - if: "$CI_COMMIT_TAG"
      when: on_success
    # Send validation notification on main branch
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - "charts/*/Chart.yaml"
      when: on_success
    # Send validation notification on merge requests
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: on_success

# Notify when charts are published to registry (after approval)
notify:published:
  extends: .base-job
  stage: notify
  needs:
    - job: detect:changes
      optional: true
    - job: publish:charts
      optional: true
  script:
    - python3 scripts/ci/notify.py --type published --input-file changed-charts.txt
  dependencies:
    - detect:changes
  rules:
    # Exclude scheduled pipelines (Renovate, metrics)
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # Send publish notification on tags
    - if: "$CI_COMMIT_TAG"
      when: on_success
    # Send publish notification on main branch
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - "charts/*/Chart.yaml"
      when: on_success

# ==============================================================================
# Metrics Stage
# ==============================================================================
# Collect and analyze chart performance metrics

metrics:chart-performance:
  extends: .base-job
  stage: metrics
  needs:
    - job: build:ci-image
      optional: true
    - job: test:ci-scripts
      optional: true
  script:
    - |
      python3 scripts/ci/chart_metrics.py \
        --output chart-metrics.md \
        --format markdown
  artifacts:
    paths:
      - chart-metrics.md
    expire_in: 30 days
  rules:
    # Run on metrics schedule (weekly/monthly)
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $SCHEDULE_TYPE == "metrics"'
      when: always

# ==============================================================================
# Renovate Stage - Dependency Updates
# ==============================================================================
# Automated dependency updates using Renovate Bot

renovate:
  stage: renovate
  image: renovate/renovate:${RENOVATE_VERSION}
  before_script:
    - echo "GitLab API - $CI_API_V4_URL"
    - echo "Repository - $CI_PROJECT_PATH"
  variables:
    # Node.js configuration
    NODE_NO_WARNINGS: "1"

    # GitLab platform configuration
    RENOVATE_PLATFORM: "gitlab"
    RENOVATE_ENDPOINT: $CI_API_V4_URL
    RENOVATE_AUTODISCOVER: "false"
    RENOVATE_REPOSITORIES: '["$CI_PROJECT_ID"]'

    # Behavior configuration
    RENOVATE_REQUIRE_CONFIG: "optional" # Options: "required", "optional", "ignored"
    RENOVATE_ONBOARDING: "false"

    # Logging configuration
    LOG_LEVEL: "info"

    # Authentication tokens
    # RENOVATE_TOKEN: Inherited from CI/CD variable
    #   (GitLab PAT or Project Access Token with 'api' scope)
    #   - Required for creating MRs/issues
    #   - Without this, Renovate can only read (using CI_JOB_TOKEN)
    #   - Must be set in: Settings > CI/CD > Variables > Add Variable
    # GITHUB_COM_TOKEN: Inherited from CI/CD variable
    #   (for fetching GitHub release data)

    # Docker Hub authentication
    # Set these in GitLab CI/CD Variables:
    #   - DOCKER_HUB_USERNAME: Your Docker Hub username
    #   - DOCKER_HUB_TOKEN: Your Docker Hub access token
    RENOVATE_HOST_RULES: |
      [
        {
          "matchHost": "docker.io",
          "hostType": "docker",
          "username": "${DOCKER_HUB_USERNAME}",
          "password": "${DOCKER_HUB_TOKEN}"
        }
      ]

    # Performance optimization
    RENOVATE_REPOSITORY_CACHE: "reset" # Options: "disabled", "enabled", "reset"
    RENOVATE_CACHE_DIR: .renovate-cache
    RENOVATE_PERSIST_REPO_DATA: "true"

    # Cache configuration
    RENOVATE_CACHE_PRIVATE_PACKAGES: "true"

    # Dry run mode
    RENOVATE_DRY_RUN: "" # Options: "extract", "lookup", "full" or "" (to disable)
  script:
    - renovate $RENOVATE_EXTRA_FLAGS
  cache:
    key: "renovate-cache"
    paths:
      - .renovate-cache
  rules:
    # Run on scheduled Renovate pipeline
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $SCHEDULE_TYPE == "renovate"'
      when: always
    # Manual trigger via web UI (with debug logging and dry-run)
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
      allow_failure: true
      variables:
        LOG_LEVEL: "debug"
        RENOVATE_DRY_RUN: "full"
  tags:
    - talos
  retry:
    max: 2
    when:
      - api_failure
      - runner_system_failure
      - stuck_or_timeout_failure
  timeout: 2 hours
  allow_failure: true
